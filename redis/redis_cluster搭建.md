| operator | createtime | updatetime |
| ---- | ---- | ---- |
| shenx | 2024-3月-25 | 2024-3月-25  |
| ... | ... | ... |
---
# redis_cluster搭建

[toc]

## 环境
| 环境 | 版本 |
| ---- | ---- |
| linux | CentOS Linux release 7.9.2009 (Core) |
| docker | Docker version 24.0.7 |
| images | redis:6.2-alpine(docker pull redis:6.2-alpine) |

## 安装
```bash
docker pull redis:6.2-alpine
```

***配置文件*** <br>

关键配置项为  
: cluster-enabled yes
: cluster-config-file /data/nodes-cluster.conf
: cluster-node-timeout 15000

其余可以参考默认的redis 配置文件
这里给出我使用的配置文件
```bash
daemonize yes
bind 0.0.0.0
protected-mode no
timeout 0
tcp-keepalive 0
loglevel notice
databases 16
rdbchecksum yes
rdbcompression yes
replica-serve-stale-data no
replica-read-only yes
repl-ping-replica-period 10
repl-timeout 60
repl-disable-tcp-nodelay no
replica-priority 100
rename-command flushdb cleandb
rename-command flushall cleanall
rename-command debug nobug
rename-command keys nokeys
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 70
auto-aof-rewrite-min-size 64mb
lua-time-limit 5000
stop-writes-on-bgsave-error yes
slowlog-log-slower-than 10000
slowlog-max-len 1024
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-entries 512
list-max-ziplist-value 64
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
activerehashing yes
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 512mb 512mb 300
client-output-buffer-limit pubsub 32mb 8mb 60
hz 10
aof-rewrite-incremental-fsync yes
rdb-save-incremental-fsync yes
maxclients 65504
#include /usr/local/data/redis/6600/conf/redis_master.conf
# Generated by CONFIG REWRITE
#aof-use-rdb-preamble no
appendonly yes
pidfile "/usr/local/data/redis/6600/run/redis.pid"
requirepass "123456"
port 6600
maxmemory 4G
logfile "/usr/local/data/redis/6600/log/redis.log"
save 3600 1
save 300 100
save 60 10000
dir "/usr/local/data/redis/6600/data"
```

注include redis_master.conf 为主从相关信息配置
```bash
port 6000
requirepass 123456
pidfile /usr/local/data/redis/6000/run/redis.pid
logfile /usr/local/data/redis/6000/log/redis.log
dir /usr/local/data/redis/6000/data
dbfilename dump.rdb
aof-use-rdb-preamble no
appendonly yes
appendfsync everysec
appendfilename appendonly.aof
maxmemory 24G
maxmemory-policy noeviction
```

## 批量操作redis-container
```bash
# 启动
docker run -d -v /data/redis/6000:/usr/local/etc/redis -p 6000:6000 -p 16000:16000 -v /data/redis/6000/data:/data  --name myredis-6000 redis:6.2-alpine redis-server  /usr/local/etc/redis/redis.conf
docker run -d -v /data/redis/6001:/usr/local/etc/redis -p 6001:6001 -p 16001:16001 -v /data/redis/6001/data:/data  --name myredis-6001 redis:6.2-alpine redis-server  /usr/local/etc/redis/redis.conf
docker run -d -v /data/redis/6002:/usr/local/etc/redis -p 6002:6002 -p 16002:16002 -v /data/redis/6002/data:/data  --name myredis-6002 redis:6.2-alpine redis-server  /usr/local/etc/redis/redis.conf
docker run -d -v /data/redis/6003:/usr/local/etc/redis -p 6003:6003 -p 16003:16003 -v /data/redis/6003/data:/data  --name myredis-6003 redis:6.2-alpine redis-server  /usr/local/etc/redis/redis.conf
docker run -d -v /data/redis/6004:/usr/local/etc/redis -p 6004:6004 -p 16004:16004 -v /data/redis/6004/data:/data  --name myredis-6004 redis:6.2-alpine redis-server  /usr/local/etc/redis/redis.conf
docker run -d -v /data/redis/6005:/usr/local/etc/redis -p 6005:6005 -p 16005:16005 -v /data/redis/6005/data:/data  --name myredis-6005 redis:6.2-alpine redis-server  /usr/local/etc/redis/redis.conf

# 批量操作docker
docker ps -a | awk -F " " '{print $1}' |tail -n +2 |xargs  -n 1 docker restart
docker ps -a | awk -F " " '{print $1}' |tail -n +2 |xargs  -n 1 docker stop
docker ps -a | awk -F " " '{print $1}' |tail -n +2 |xargs  -n 1 docker rm

```

可能会涉及到对配置文件的修改
这里给出我使用的批量修改脚本
```bash
sed -i -e "s/# cluster-enabled yes/cluster-enabled yes/g" /data/redis/6000/redis.conf
sed -i -e "s/# cluster-enabled yes/cluster-enabled yes/g" /data/redis/6001/redis.conf
sed -i -e "s/# cluster-enabled yes/cluster-enabled yes/g" /data/redis/6002/redis.conf
sed -i -e "s/# cluster-enabled yes/cluster-enabled yes/g" /data/redis/6003/redis.conf
sed -i -e "s/# cluster-enabled yes/cluster-enabled yes/g" /data/redis/6004/redis.conf
sed -i -e "s/# cluster-enabled yes/cluster-enabled yes/g" /data/redis/6005/redis.conf
```

创建集群
```bash 
redis-cli --cluster create --cluster-replicas 1 172.29.29.101:6000 172.29.29.101:6001 172.29.29.101:6002 172.29.29.101:6003 172.29.29.101:6004 172.29.29.101:6005 -a 123456
```


## 可能出现的问题记录
**1. bind 问题**  
bind 参数默认为127.0.0.1. 即不允许远程访问

**2. Sending CLUSTER MEET messages to join the cluster Waiting for the cluster to join .................................**  
可能是仅仅开放了redis 的访问端口，没有开放集群总线端口，集群总线端口为 port + 10000

**3.Sorry, the cluster configuration file nodes.conf is already used by a different Redis Cluster node.**  
多个redis 使用了同一个cluster-config-file，不同的redis要使用不同的文件路径
